name: Vault OIDC Integration

on:
  workflow_call:
    inputs:
      vault-addr:
        description: 'Vault server address'
        required: true
        type: string
      vault-role:
        description: 'Vault JWT role name'
        default: 'github-actions'
        type: string
    outputs:
      vault-token:
        description: 'Vault token for accessing secrets'
        value: ${{ jobs.auth.outputs.token }}

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  auth:
    name: Authenticate with Vault via OIDC
    runs-on: ubuntu-latest
    outputs:
      token: ${{ steps.vault-auth.outputs.token }}
    
    steps:
      - name: Get GitHub OIDC Token
        id: oidc
        run: |
          # Request OIDC token from GitHub
          OIDC_TOKEN=$(curl -sS -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://github.com/gradeloop" | jq -r '.value')
          echo "::add-mask::$OIDC_TOKEN"
          echo "token=$OIDC_TOKEN" >> $GITHUB_OUTPUT
      
      - name: Authenticate with Vault
        id: vault-auth
        env:
          VAULT_ADDR: ${{ inputs.vault-addr }}
        run: |
          # Authenticate using JWT/OIDC
          VAULT_TOKEN=$(curl -sS -X POST \
            -H "Content-Type: application/json" \
            -d "{\"jwt\":\"${{ steps.oidc.outputs.token }}\",\"role\":\"${{ inputs.vault-role }}\"}" \
            "${VAULT_ADDR}/v1/auth/jwt/login" | jq -r '.auth.client_token')
          
          if [ -z "$VAULT_TOKEN" ] || [ "$VAULT_TOKEN" = "null" ]; then
            echo "Failed to authenticate with Vault"
            exit 1
          fi
          
          echo "::add-mask::$VAULT_TOKEN"
          echo "token=$VAULT_TOKEN" >> $GITHUB_OUTPUT
          echo "VAULT_TOKEN=$VAULT_TOKEN" >> $GITHUB_ENV
      
      - name: Verify Vault Access
        env:
          VAULT_ADDR: ${{ inputs.vault-addr }}
          VAULT_TOKEN: ${{ steps.vault-auth.outputs.token }}
        run: |
          # Test that we can read a secret
          curl -sS -H "X-Vault-Token: $VAULT_TOKEN" \
            "${VAULT_ADDR}/v1/secret/data/database/postgres" || {
            echo "Failed to verify Vault access"
            exit 1
          }
          echo "Successfully authenticated with Vault"
