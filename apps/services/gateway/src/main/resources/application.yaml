spring:
  application:
    name: gateway
  config:
    import: optional:file:./.env[.properties]
  cloud:
    gateway:
      routes:
        - id: iam-service-public
          uri: lb://iam-service
          predicates:
            - Path=/auth/**,/v1/auth/**
          filters:
            - RewritePath=/auth(?<segment>.*),/api/v1/auth$\{segment}
            - RewritePath=/v1/auth(?<segment>.*),/api/v1/auth$\{segment}
        - id: iam-service-protected
          uri: lb://iam-service
          predicates:
            - Path=/api/iam/**,/iam/**
          filters:
            - RewritePath=/api/iam(?<segment>.*),/api/v1/iam$\{segment}
            - RewritePath=/iam(?<segment>.*),/api/v1/iam$\{segment}
            - name: CircuitBreaker
              args:
                name: iamCircuitBreaker
                fallbackUri: forward:/fallback/iam
            - name: RequestRateLimiter
              args:
                redis-rate-limiter:
                  replenish-rate: 100
                  burst-capacity: 200
                  requested-tokens: 1
        - id: actuator
          uri: http://localhost:8080
          predicates:
            - Path=/actuator/**
          filters:
            - StripPrefix=1
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOriginPatterns:
              - "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - PATCH
              - OPTIONS
            allowedHeaders:
              - "*"
            allowCredentials: true
            maxAge: 3600
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      httpclient:
        connect-timeout: 5000
        response-timeout: 10s
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin

  # Resilience4j Circuit Breaker Configuration
  resilience4j:
    circuitbreaker:
      config:
        default:
          slidingWindowSize: 10
          minimumNumberOfCalls: 5
          permittedNumberOfCallsInHalfOpenState: 3
          automaticTransitionFromOpenToHalfOpenEnabled: true
          waitDurationInOpenState: 5s
          failureRateThreshold: 50
          eventConsumerBufferSize: 10
    timelimiter:
      config:
        default:
          timeout-duration: 10s

  # Eureka Client Configuration
eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_SERVER_URL:http://eureka-server:8761/eureka/}
    register-with-eureka: true
    fetch-registry: true
    registry-fetch-interval-seconds: 10
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${server.port}
    lease-renewal-interval-in-seconds: 10

# Server Configuration
server:
  port: ${SERVER_PORT:8080}

# Management & Actuator
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway,circuitbreakers
      base-path: /actuator
  endpoint:
    health:
      show-details: always
  health:
    circuitbreakers:
      enabled: true

# Logging Configuration
logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: DEBUG
    com.gradeloop.gateway: DEBUG
  pattern:
    console: '{"timestamp":"%d{yyyy-MM-dd''T''HH:mm:ss.SSSZ}","level":"%p","thread":"%t","logger":"%c{1}","message":%m%n}'

# JWT Configuration
jwt:
  public-key: classpath:public_key.pem
  algorithm: ${JWT_ALGORITHM:RS256}
  access-token-header: Authorization
  access-token-prefix: Bearer
