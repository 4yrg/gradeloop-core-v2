version: "3.8"

# DB-less Kong docker-compose for local/dev gateway
# - Kong runs in DB-less mode (KONG_DATABASE=off) and loads declarative config from infra/kong/kong.yml
# - Exposes proxy on 8000 (HTTP) and 8443 (HTTPS), Admin API on 8001 (lock down in prod)
# - Services are attached to a dedicated network `gateway_network`
# - Replace image placeholders or switch to `build:` if you prefer building services locally

services:
  kong:
    image: kong:latest
    container_name: kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_LISTEN: "0.0.0.0:8000, 0.0.0.0:8443 ssl"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
    ports:
      - "8000:8000"   # Kong proxy (HTTP)
      - "8443:8443"   # Kong proxy (HTTPS) - optional for local dev
      - "8001:8001"   # Kong Admin API (DO NOT expose in production without securing it)
    volumes:
      - ../../infra/kong/kong.yml:/kong/kong.yml:ro
    restart: unless-stopped
    networks:
      - gateway_network
    healthcheck:
      test: ["CMD-SHELL", "kong health --cacert /dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  auth-service:
    # Recommended: build locally from the repo if you are actively developing the auth service.
    # Uncomment the `build` section to build from local context.
    # build:
    #   context: ../../apps/services/auth-service
    #   dockerfile: Dockerfile
    image: my-registry/auth-service:latest
    container_name: gradeloop-auth-service
    environment:
      - PORT=3000
      # Add other env vars here, or use an env_file:
      # - SECRET=${SECRET}
    # If you want Kong to be the only entrypoint, do NOT publish the auth-service port to the host.
    # For debugging you can optionally publish: "3000:3000"
    networks:
      - gateway_network
    depends_on:
      - kong
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/iam/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Example placeholder for another downstream service
  api-service:
    image: my-registry/api-service:latest
    container_name: gradeloop-api-service
    environment:
      - PORT=3000
    networks:
      - gateway_network
    restart: unless-stopped

networks:
  gateway_network:
    driver: bridge

# Notes:
# - Place your Kong declarative config at gradeloop-core-v2/infra/kong/kong.yml.
#   The declarative file should define services, routes and plugin configuration (JWT/OIDC or serverless validation).
# - For JWT validation using IAM JWKS:
#   - Use a plugin that supports jwks_uri (e.g., kong-oidc community plugin) and point it to the IAM JWKS endpoint.
# - For ForwardAuth-style validation (i.e., Kong calling IAM on each request) you can:
#   - Use the serverless-functions plugin with a small Lua pre-function that calls the IAM validate endpoint, or
#   - Use an existing introspection/introspection-like plugin if available.
# - In production, prefer Kong with Postgres (KONG_DATABASE=postgres) and do NOT expose the Admin API publicly.
