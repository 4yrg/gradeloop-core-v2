# Infra compose that merges the root `compose.yaml` Traefik gateway into infra/compose.
# - Traefik v3.0 configured with two entrypoints: `web` (80) and `traefik` (8080 dashboard)
# - Docker provider enabled with exposedByDefault=false (services must opt-in with traefik.enable=true)
# - Auth service built from local context (apps/services/auth-service) and attached to gateway_network
# - Auth service does NOT publish host ports; it is only reachable via Traefik
#
# Usage:
#   cd infra/compose
#   docker compose up -d
#
# Notes:
# - The auth service still reads environment variables from ../../.env (keeps parity with existing infra)
# - Traefik uses the Docker socket for discovery: /var/run/docker.sock (read-only mount)
# - If you prefer to pull an image instead of building locally, replace the auth-service `build:` block with `image: my-registry/auth-service:latest`

services:
  keygen:
    image: alpine:3.18
    container_name: kong-keygen
    restart: "no"
    # Bind the infra/kong directory so keygen can write keys and the rendered kong.yml
    volumes:
      - ../../infra/kong:/work
    entrypoint: ["/bin/sh", "/work/keygen/generate_keys.sh"]
    command: []

  kong:
    image: kong:latest
    container_name: kong
    restart: unless-stopped
    depends_on:
      - keygen
      - auth-service
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_LISTEN: "0.0.0.0:8000, 0.0.0.0:8443 ssl"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
    ports:
      - "8000:8000" # Kong proxy (HTTP)
      - "8443:8443" # Kong proxy (HTTPS) - optional for local dev
      - "8001:8001" # Kong Admin API (DO NOT expose in production without securing it)
    # Mount the rendered kong directory and the generated keys directory.
    # Use a small wait entrypoint so Kong does not start until /kong/kong.yml exists
    # (prevents the common case where a missing host file is created as a directory).
    entrypoint:
      [
        "/bin/sh",
        "-c",
        "until [ -f /kong/kong.yml ]; do echo 'waiting for /kong/kong.yml'; sleep 0.3; done; exec /docker-entrypoint.sh kong docker-start",
      ]
    volumes:
      - ../../infra/kong/rendered:/kong:ro
      - ../../infra/kong/keys:/kong/keys:ro
    networks:
      - gateway_network
    healthcheck:
      test: ["CMD-SHELL", "kong health --cacert /dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  auth-service:
    # Build locally from the repo's auth-service folder (keeps infra self-contained)
    build:
      context: ../../apps/services/auth-service
      dockerfile: Dockerfile
    container_name: gradeloop-auth-service
    hostname: auth-service
    restart: unless-stopped
    env_file:
      - ../../.env # keep reading Aiven / DB env vars from repo-level .env (do not commit secrets)
    environment:
      # Ensure the service listens on the internal port expected by upstream (3000).
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=3000
      # Optional DB fallback vars left available (prefer Aiven vars in ../../.env)
      - DB_USER=${DB_USER:-}
      - DB_PASSWORD=${DB_PASSWORD:-}
      # Provide path to private key for the auth service to sign tokens (auth-service should read this)
      - RSA_PRIVATE_KEY_PATH=/kong/keys/private.pem
    # Do NOT publish host ports for services intended to be reached only via the gateway.
    # Expose the internal port to other containers (optional) so Docker knows it's reachable.
    expose:
      - "3000"
    networks:
      - gateway_network
      - gradeloop-network # keep the original infra network attached for any existing internal connectivity
    healthcheck:
      # Simple check â€” adjusts to the service's actual health endpoint if different
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Kong handles routing via the declarative manifest at infra/kong/rendered/kong.yml.
    # The keygen service ensures infra/kong/keys and infra/kong/rendered/kong.yml are created before Kong starts.
    # Auth service will be able to read /work/keys/private.pem via the bind mount (path provided in env).

# ------------------------
# Future Service Template (commented)
# ------------------------
# Copy-paste this block when adding a new microservice and adapt values.
#
# my-service:
#   image: "my-registry/my-service:latest"   # or use build: { context: ... }
#   container_name: my-service
#   restart: unless-stopped
#   env_file:
#     - ../../.env
#   networks:
#     - gateway_network
#   labels:
#     "traefik.enable": "true"
#     "traefik.http.routers.myservice-router.rule": "Host(`localhost`) && PathPrefix(`/api/myservice`)"
#     "traefik.http.routers.myservice-router.entrypoints": "web"
#     "traefik.http.routers.myservice-router.middlewares": "myservice-stripprefix@docker,myservice-ratelimit@docker"
#     "traefik.http.services.myservice.loadbalancer.server.port": "<INTERNAL_PORT>"
#     "traefik.http.middlewares.myservice-stripprefix.stripprefix.prefixes": "/api/myservice"
#     "traefik.http.middlewares.myservice-ratelimit.ratelimit.average": "10"
#     "traefik.http.middlewares.myservice-ratelimit.ratelimit.burst": "0"
#     "traefik.docker.network": "gateway_network"

networks:
  # Gateway network used by Traefik + routed services
  gateway_network:
    name: gateway_network
    driver: bridge

  # Original infra network preserved for other internal services
  gradeloop-network:
    name: gradeloop-network
    driver: bridge
