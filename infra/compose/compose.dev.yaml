services:
  # Traefik - API Gateway
  traefik:
    image: traefik:v3.1
    container_name: gradeloop-gateway-dev
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      # Metrics
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"
      # Enable JWT Validator Plugin
      - "--experimental.plugins.jwt-validator.moduleName=github.com/Luka-S/traefik-jwt-validator"
      - "--experimental.plugins.jwt-validator.version=v1.3.0"
    ports:
      - "80:80"
      - "8080:8080" # Dashboard
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    environment:
      - JWT_SECRET=gradeloop_dev_secret_32_chars_long_!!
    networks:
      - gradeloop-network

  # HashiCorp Vault - Secrets Management (Dev Mode)
  vault:
    image: hashicorp/vault:1.15
    container_name: gradeloop-vault-dev
    hostname: vault
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "dev-root-token"
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
      VAULT_ADDR: "http://127.0.0.1:8200"
      VAULT_LOG_LEVEL: "info"
    cap_add:
      - IPC_LOCK
    volumes:
      - vault-audit-logs:/vault/logs
    command: server -dev -dev-root-token-id="dev-root-token"
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 2s
      timeout: 5s
      retries: 15
    networks:
      - gradeloop-network

  # Vault Initializer - Seeds initial secrets on startup
  vault-init:
    image: hashicorp/vault:1.15
    container_name: gradeloop-vault-init
    depends_on:
      vault:
        condition: service_healthy
    environment:
      VAULT_ADDR: "http://vault:8200"
      VAULT_TOKEN: "dev-root-token"
    volumes:
      - ../../scripts/vault-init.sh:/vault-init.sh:ro
      - ./vault/secrets:/vault/secrets:rw
    command: /bin/sh /vault-init.sh
    networks:
      - gradeloop-network
    restart: "no"

  # PostgreSQL - Database
  postgres:
    image: postgres:16-alpine
    container_name: gradeloop-postgres-dev
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: gradeloop
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 2s
      timeout: 5s
      retries: 15
    networks:
      - gradeloop-network

  # IAM Service - Identity and Access Management
  iam-service:
    build:
      context: ../../
      dockerfile: apps/services/iam-service/Dockerfile
    container_name: gradeloop-iam-service-dev
    ports:
      - "3000:3000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.iam.loadbalancer.server.port=3000"

      # Public IAM Routes (Auth endpoints that don't require JWT)
      - "traefik.http.routers.iam-public.rule=PathPrefix(`/api/iam/v1/auth/login`) || PathPrefix(`/api/iam/v1/auth/refresh`) || PathPrefix(`/api/iam/v1/auth/activate`) || PathPrefix(`/api/iam/v1/auth/request-activation`) || PathPrefix(`/api/iam/metrics`)"
      - "traefik.http.routers.iam-public.entrypoints=web"
      - "traefik.http.routers.iam-public.middlewares=iam-replacepath"

      # Protected IAM Routes (Requires JWT Validation at the Edge)
      - "traefik.http.routers.iam-protected.rule=PathPrefix(`/api/iam`) && !(PathPrefix(`/api/iam/v1/auth/login`) || PathPrefix(`/api/iam/v1/auth/refresh`) || PathPrefix(`/api/iam/v1/auth/activate`) || PathPrefix(`/api/iam/v1/auth/request-activation`) || PathPrefix(`/api/iam/metrics`))"
      - "traefik.http.routers.iam-protected.entrypoints=web"
      - "traefik.http.routers.iam-protected.middlewares=iam-jwt-auth,iam-replacepath"

      # Middlewares
      - "traefik.http.middlewares.iam-replacepath.replacepathregex.regex=^/api/iam(.*)"
      - "traefik.http.middlewares.iam-replacepath.replacepathregex.replacement=/api$$1"

      # Edge Security: JWT Validation Middleware (Shared Secret from environment)
      - "traefik.http.middlewares.iam-jwt-auth.plugin.jwt-validator.secret=gradeloop_dev_secret_32_chars_long_!!"
      - "traefik.http.middlewares.iam-jwt-auth.plugin.jwt-validator.proxyHeaderName=Authorization"
      - "traefik.http.middlewares.iam-jwt-auth.plugin.jwt-validator.authHeaderRequired=true"

      # Forwarding validated user context via headers
      - "traefik.http.middlewares.iam-jwt-auth.plugin.jwt-validator.claimsToHeaders.sub=X-User-Id"
      - "traefik.http.middlewares.iam-jwt-auth.plugin.jwt-validator.claimsToHeaders.roles=X-User-Roles"
      - "traefik.http.middlewares.iam-jwt-auth.plugin.jwt-validator.claimsToHeaders.permissions=X-User-Permissions"
    environment:
      VAULT_ADDR: "http://vault:8200"
      VAULT_TOKEN: "dev-root-token"
    depends_on:
      postgres:
        condition: service_healthy
      vault:
        condition: service_healthy
    develop:
      watch:
        - action: rebuild
          path: ../../apps/services/iam-service
        - action: rebuild
          path: ../../shared/libs/go/secrets
        - action: rebuild
          path: ../../shared/libs/go/middleware
    networks:
      - gradeloop-network

  # Prometheus - Metrics Collection
  prometheus:
    image: prom/prometheus:v2.51.0
    container_name: gradeloop-prometheus-dev
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    ports:
      - "9090:9090"
    networks:
      - gradeloop-network

  # Grafana - Visualization
  grafana:
    image: grafana/grafana:10.4.0
    container_name: gradeloop-grafana-dev
    ports:
      - "3001:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - gradeloop-network

networks:
  gradeloop-network:
    name: gradeloop-network
    driver: bridge

volumes:
  vault-audit-logs:
    name: gradeloop-vault-audit-logs
  postgres-data:
  postgres-secrets:
  prometheus-data:
  grafana-data:
