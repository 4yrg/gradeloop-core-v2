# Docker Compose for Traefik v3 API Gateway + Auth Service integration
# - Traefik acts as the single entrypoint for all microservices
# - Auth service is only reachable via Traefik (no host ports exposed)
# - Network: gateway_network (dedicated Docker network for the gateway + services)
#
# Usage:
#  - Start: `docker compose -f compose.yaml up -d`
#  - Verify routing: see "Verify with curl" notes below
#
# NOTE: This compose file uses a placeholder image for the auth service:
#   `my-registry/auth-service:latest`
# Replace that with your actual image name (or add a build context if you want Compose to build it).
#
# IMPORTANT: This compose file intentionally sets `providers.docker.exposedbydefault=false`
# so only containers with `traefik.enable=true` will be picked up by Traefik.
#
version: "3.9"

services:
  traefik:
    image: "traefik:v3.0"                    # Traefik v3.0
    container_name: traefik
    restart: unless-stopped
    command:
      # Static configuration (CLI flags). Comments below explain each flag.
      - --providers.docker=true                              # Enable Docker provider
      - --providers.docker.exposedbydefault=false            # Only pick containers with traefik.enable=true
      - --providers.docker.endpoint=unix:///var/run/docker.sock
      - --entrypoints.web.address=:80                        # Public HTTP entrypoint (port 80)
      - --entrypoints.traefik.address=:8080                  # Traefik Dashboard entrypoint (port 8080)
      - --api=true                                           # Enable API (required to expose dashboard)
      - --api.dashboard=true                                 # Enable Dashboard UI
      - --log.level=INFO
      # (Optional) Persist Traefik logs or enable further config via file provider here.
    ports:
      - "80:80"      # Exposes the `web` entrypoint on host port 80 (for HTTP traffic)
      - "8080:8080"  # Exposes the Traefik dashboard on host port 8080
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro   # Docker socket for service discovery (read-only)
      # - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro  # Optional: use a file provider if you prefer
    networks:
      - gateway_network
    # Put minimal labels on the Traefik container itself if you want to protect the dashboard with a router rule,
    # but for local dev we're exposing the dashboard directly on :8080.
    labels:
      # Example (commented) label: expose dashboard only on Host(`localhost`) and PathPrefix(`/traefik`)
      # "traefik.http.routers.traefik.rule": "Host(`localhost`) && PathPrefix(`/traefik`)"
      # "traefik.http.routers.traefik.entrypoints": "traefik"
      # "traefik.http.routers.traefik.service": "api@internal"
      #
      # The above can be enabled if you want to gate dashboard behind Traefik's routing rules.
      # For now we rely on the `--api.dashboard=true` + direct host port 8080 mapping.

  auth-service:
    image: "my-registry/auth-service:latest"  # Placeholder image – replace with your registry/image
    container_name: auth-service
    # Do NOT publish container ports to host: service is only reachable via Traefik.
    # If you prefer to build locally instead of using a registry, replace `image:` with:
    # build:
    #   context: ./apps/services/auth-service
    #   dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      # Example env vars. Configure these in an .env file or override in your deployment.
      # SECRET: "REPLACE_WITH_REAL_SECRET"
      # POSTGRES_URL_BASE: "postgres://..."
      # AUTH_SVC_DB_NAME: "auth_db"
      # (Do not check secrets into Git.)
    networks:
      - gateway_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]  # adjust path to your service health endpoint
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      # This label explicitly allows Traefik to discover this container.
      "traefik.enable": "true"   # Must be true because exposedByDefault=false

      # Router: route requests to this service when Host is localhost AND path begins with /api/auth
      # - Rule explanation: Host(`localhost`) && PathPrefix(`/api/auth`)
      #   This maps requests like: http://localhost/api/auth/login  -> to this router
      "traefik.http.routers.auth-router.rule": "Host(`localhost`) && PathPrefix(`/api/auth`)"
      "traefik.http.routers.auth-router.entrypoints": "web"    # Use the `web` entrypoint (port 80)

      # Attach middlewares (strip prefix + rate limit)
      # Middlewares are referenced by name and will be defined on this container as labels.
      # Using `@docker` suffix tells Traefik to look for the middleware in the Docker provider.
      "traefik.http.routers.auth-router.middlewares": "auth-stripprefix@docker,auth-ratelimit@docker"

      # Connect the router to a service name (traefik will auto-create the service but defining it is explicit)
      "traefik.http.routers.auth-router.service": "auth-service"

      # Tell Traefik which port the service listens on inside the container.
      # Traefik will route traffic to container:3000
      "traefik.http.services.auth-service.loadbalancer.server.port": "3000"

      # ------------------------
      # Middleware: StripPrefix
      # ------------------------
      # This middleware removes the `/api/auth` prefix so the upstream service receives path starting at `/`.
      # Example:
      #  Request: GET /api/auth/login  -> after stripprefix -> /login -> forwarded to auth-service
      "traefik.http.middlewares.auth-stripprefix.stripprefix.prefixes": "/api/auth"

      # ------------------------
      # Middleware: RateLimit
      # ------------------------
      # Protects the auth endpoints from brute-force by limiting request rate.
      # Traefik rateLimit uses `average` (reqs per second) and `burst` (additional capacity).
      # Set average=10 to limit to roughly 10 requests/second.
      "traefik.http.middlewares.auth-ratelimit.ratelimit.average": "10"  # average requests per second
      "traefik.http.middlewares.auth-ratelimit.ratelimit.burst": "0"     # no burst allowed (strict cap)

      # Optional: you can add a retry/fallback or an error page middleware here if desired.
      #
      # Network annotation to ensure Traefik uses the same Docker network when querying this container.
      "traefik.docker.network": "gateway_network"

    # Do NOT add `ports:` here — keep service accessible only via Traefik.
    # ports:
    #   - "3000:3000"   # <-- intentionally omitted

# ------------------------
# Future Service Template
# ------------------------
# Copy-paste this commented block to add another microservice behind Traefik.
#
# Put this under `services:` and adjust `service_name`, `image`, `internal_port`, and the router rule as needed.
#
#  my-service:
#    image: "my-registry/my-service:latest"
#    container_name: my-service
#    restart: unless-stopped
#    networks:
#      - gateway_network
#    labels:
#      "traefik.enable": "true"   # must be true since exposedByDefault=false
#      # Route requests for /api/myservice to this container
#      "traefik.http.routers.myservice-router.rule": "Host(`localhost`) && PathPrefix(`/api/myservice`)"
#      "traefik.http.routers.myservice-router.entrypoints": "web"
#      # Optionally attach the same stripprefix middleware pattern to remove the /api/myservice prefix:
#      "traefik.http.routers.myservice-router.middlewares": "myservice-stripprefix@docker"
#      # Define the service port that the container listens on
#      "traefik.http.services.myservice.loadbalancer.server.port": "3001"
#      # Define the stripprefix middleware for this service
#      "traefik.http.middlewares.myservice-stripprefix.stripprefix.prefixes": "/api/myservice"
#      # Ensure Traefik uses the same docker network
#      "traefik.docker.network": "gateway_network"
#
# If you need a rate limit for the new service, reuse the pattern above:
# "traefik.http.middlewares.myservice-ratelimit.ratelimit.average": "10"
# "traefik.http.middlewares.myservice-ratelimit.ratelimit.burst": "0"
#
# For TLS, add `traefik.http.routers.myservice-router.tls=true` and configure certificates via ACME or your provider.

networks:
  gateway_network:
    name: gateway_network
    driver: bridge

# --------------------------------------------------------------------------
# Quick verification commands
# --------------------------------------------------------------------------
# 1) Start the stack:
#    docker compose -f compose.yaml up -d
#
# 2) Verify Traefik is up and has discovered the auth service:
#    - Dashboard: http://localhost:8080
#    - Docker logs: docker logs -f traefik
#
# 3) Test routing with curl:
#    - Health check (if auth-service exposes /health):
#      curl -v http://localhost/api/auth/health
#
#    - Login (example, forwards to /login after stripprefix):
#      curl -v http://localhost/api/auth/login -d '{"username":"test","password":"x"}' -H "Content-Type: application/json"
#
# Notes:
#  - Requests should hit Traefik on port 80 (http) and Traefik will forward to the auth-service container on port 3000.
#  - Because we use `stripprefix`, the auth-service sees a request path of `/login` when you call `/api/auth/login`.
#  - The ratelimit middleware will limit the requests roughly to 10 req/s (average). If you need bursty traffic,
#    raise the `burst` value in the ratelimit middleware.
# --------------------------------------------------------------------------
